<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const pageVersion = 3
    const useStubData = true
    var stubDataSource = null
    if (useStubData) { var stubData = import("./stub-data.js") }
  </script>
  <link rel="stylesheet" href="css/fontello-grain.css">
  <style>
      body {
          color: var(--tg-theme-text-color);
          background: var(--tg-theme-bg-color);
          display: flex;
          flex-direction: column;
          align-items: center;
          font-size: 18px;
      }

      .hint {
          color: var(--tg-theme-hint-color);
      }

      .link {
          color: var(--tg-theme-link-color);
      }

      .button {
          background: var(--tg-theme-button-color);
          color: var(--tg-theme-button-text-color);
          border: none;
          font-size: 18px;
      }

      .button:not(:last-child) {
          margin-bottom: 20px
      }

      #usercard {
          text-align: center;
      }
  </style>
</head>
<body>
</body>
<script>
  const tg = window.Telegram.WebApp;
  tg.expand()
  // fetch("http://192.168.0.190:8080/api/v1/grainnotes/my", {
  //   headers: {
  //     "X-WebAppData": tg.initData,
  //   },
  //   mode: "cors"
  // }).then((response) => {
  //   if (!response.ok) throw new Error(`Response status ${response.status}`)
  //   else return response.json()
  // }).then((result) => {
  //   result.forEach((item) => addNoteCard(item))
  // }).catch((error) => displayError(error))

  stubData.then((v) => {
        stubDataSource = v
        displayOffers()
      }
  );

  function displayOffers() {
    document.body.innerHTML = ""
    stubDataSource.offersForBuyer.forEach((item) => addOfferCard(item))

  }

  function addOfferCard(item) {
    const noteCard = document.createElement("div")
    noteCard.style="margin-bottom: 20px;"
    noteCard.innerHTML=`${offerHTML(item)}
                            <div style="display: flex">
                          <button data-id=${item.id} id="btnBuy" style="padding-left: 1em; padding-right: 1em; flex-grow: 0; border-radius:1em;">Купить</button>
                          <!--span style="flex-grow: 1">${""}</span-->
                          <span style="font-family: monospace"><i class="icon-star"></i>${pageVersion}</span>
                        </div>`
    noteCard.querySelector("#btnBuy").addEventListener("click", onClickBuy)
    document.body.appendChild(noteCard)
  }

  function offerHTML(offer) {
    const additionalProperties =["Год урожая", "Влажность, %", "Примесь сорная, %", "Примесь зерновая/масличная, %",
      "Натура", "Клейковина, %",  "Клейковина, усл.ед.", "Число падения, с", "Белок, %", "Стекловидность, %"]
    const additionalPropertiesHtml = additionalProperties.map( (propName) =>
        `<span style ="flex-shrink: 0; font-size: small">${propName}:&nbsp${offer[propName]}&nbsp&nbsp</span>`
    ).join("")
    return `<div style="display: flex;">
                          <span style="flex-grow: 1; font-weight: bold">${offer["Культура"]}</span>
                          <span style="flex-shrink: 0;font-family: monospace; font-weight: bolder">${offer.price} тг</span>
                        </div>
                        <div style="display: flex">
                          <span style="flex-grow: 1;">${offer["Класс"]}</span>
                          <span style="flex-shrink: 0; font-size: smaller; font-family: monospace; font-weight: bolder">${offer.qty} кг</span>
                        </div>
                        <div style = "display: flex; flex-wrap: wrap;">${additionalPropertiesHtml}</div>`
  }

  function displayError(error) {
    const errorLabel = document.createElement("p")
    errorLabel.classList.add("hint")
    errorLabel.textContent = `ver ${pageVersion}. ${error}`
    document.body.appendChild(errorLabel)
  }

  function onClickItemMenu(event) {
    const noteId = event.target.getAttribute("data-id")
    if (event.target.classList.contains("icon-menu")) {
      event.target.innerText = noteId
      event.target.classList.remove("icon-menu")
      event.target.classList.add("icon-star")
    } else {
      event.target.classList.remove("icon-star")
      event.target.classList.add("icon-menu")
      event.target.innerText = ""
    }
  }

  function onPointerDownItemMenu(event) {
    const color=event.target.style.backgroundColor
    event.target.style.backgroundColor = event.target.style.color
    event.target.style.color = color
  }

  function onPointerUpItemMenu(event) {
    const color=event.target.style.backgroundColor
    event.target.style.backgroundColor = event.target.style.color
    event.target.style.color = color
  }

  function onClickBuy(event) {
    const offerId = event.target.getAttribute("data-id")
    displayDealDialog(offerId)
  }

  function displayDealDialog(offerId) {
    const offer = stubDataSource.offersForBuyer.find((value => value.id = offerId))
    const dealDialog = document.createElement("div")
    dealDialog.innerHTML=`
                        <div class="hint" style ="font-size: x-large; text-align: center; margin-bottom: 20px;  ">Покупка</div>
                        ${offerHTML(offer)}
                        <form style="display: flex; flex-direction: column;">
                          <div style="display:flex; font-weight:bold; font-size: large;  margin-topm: 30px; margin-bottom: 30px;">
                            <span style="flex-grow: 1">Сумма:</span>
                            <output name="sum" style="flex-shrink: 0; font-size:x-large; font-family: monospace;">${offer.price * offer.qty}</output>
                            <span style="flex-shrink: 0">&nbspтг</span>
                          </div>
                          <div style="display:flex;  margin-bottom: 20px;">
                            <span style="flex-grow: 1">Цена:</span>
                            <output name="price" style="flex-shrink: 0; font-size:x-large; font-family: monospace;">${offer.price}</output>
                            <span style="flex-shrink: 0; min-width: 2em;">&nbspтг</span>
                          </div>

                          <div style="display:flex; margin-bottom: 20px;">
                            <span style="flex-grow: 0">Количество:</span>
                            <input name="qty" type="range" min="${offer.qty/2}" max="${offer.qty}" value="${offer.qty}"
                              oninput="this.form.qtyText.value=this.value; this.form.sum.value=this.value*this.form.price.value;"
                              style="flex-grow: 1; margin-left: 1em; margin-right: 1em;">
                            <output name="qtyText" style="flex-shrink: 0; font-size:x-large; font-family: monospace;">${offer.price}</output>
                            <span style="flex-shrink: 0; min-width: 2em;">&nbspт</span>
                          </div>
                          <div style="text-align: center; font-size: large;">
                                 <button data-id=${offer.id} id="btnBuy" style="font-size: inherit; margin: 0.5em; padding-left: 1em; padding-right: 1em; flex-grow: 0; border-radius:1em;">Оформить</button>
                                 <button data-id=${offer.id} id="btnCancel" style="font-size: inherit; margin: 0.5em; padding-left: 1em; padding-right: 1em; flex-grow: 0; border-radius:1em;">Отмена</button>
                          </div>
                        </form>`
    // noteCard.querySelector(".icon-menu").addEventListener("click", onClickItemMenu)
    // noteCard.querySelector(".icon-menu").addEventListener("pointerdown", onPointerDownItemMenu)
    // noteCard.querySelector(".icon-menu").addEventListener("pointerup", onPointerUpItemMenu)
    document.body.innerHTML = ""
    document.body.appendChild(dealDialog)
  }


</script>
</html>